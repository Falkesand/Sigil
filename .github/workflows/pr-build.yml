name: PR Build

on:
  pull_request:
    branches: [main]

concurrency:
  group: pr-build-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9  # v4.3.1
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Restore
        run: dotnet restore Sigil.slnx

      - name: Build
        run: dotnet build Sigil.slnx -c Release --no-restore

      - name: Test
        run: dotnet test Sigil.slnx -c Release --no-build

  build:
    needs: test
    strategy:
      fail-fast: false
      matrix:
        rid: [win-x64, linux-x64, linux-arm64, osx-x64, osx-arm64]
        self_contained: [true, false]
        include:
          - rid: win-x64
            os: windows-latest
            archive: zip
          - rid: linux-x64
            os: ubuntu-latest
            archive: tar
          - rid: linux-arm64
            os: ubuntu-latest
            archive: tar
          - rid: osx-x64
            os: macos-latest
            archive: tar
          - rid: osx-arm64
            os: macos-latest
            archive: tar

    runs-on: ${{ matrix.os }}
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9  # v4.3.1
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Compute version and suffix
        id: meta
        shell: bash
        env:
          PR_SHA: ${{ github.event.pull_request.head.sha }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SELF_CONTAINED: ${{ matrix.self_contained }}
        run: |
          base=$(grep '<Version>' Directory.Build.props | head -1 | sed 's/.*<Version>\(.*\)<\/Version>.*/\1/')
          if [ -z "$base" ] || [[ ! "$base" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Failed to extract valid version from Directory.Build.props: '$base'"
            exit 1
          fi
          sha="${PR_SHA:0:7}"
          ver="${base}-pr.${PR_NUMBER}+${sha}"
          echo "version=$ver" >> "$GITHUB_OUTPUT"
          if [ "$SELF_CONTAINED" = "true" ]; then
            echo "suffix=" >> "$GITHUB_OUTPUT"
          else
            echo "suffix=-fdd" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish
        run: >-
          dotnet publish src/Sigil.Cli/Sigil.Cli.csproj
          -c Release
          -r ${{ matrix.rid }}
          /p:PublishStandalone=true
          /p:SelfContained=${{ matrix.self_contained }}
          /p:Version=${{ steps.meta.outputs.version }}
          -o ./publish

      - name: Package (tar.gz)
        if: matrix.archive == 'tar'
        shell: bash
        run: tar -czf sigil-${{ steps.meta.outputs.version }}-${{ matrix.rid }}${{ steps.meta.outputs.suffix }}.tar.gz -C ./publish .

      - name: Package (zip)
        if: matrix.archive == 'zip'
        shell: pwsh
        run: Compress-Archive -Path ./publish/* -DestinationPath sigil-${{ steps.meta.outputs.version }}-${{ matrix.rid }}${{ steps.meta.outputs.suffix }}.zip

      - name: Upload artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: sigil-${{ matrix.rid }}${{ steps.meta.outputs.suffix }}
          path: sigil-${{ steps.meta.outputs.version }}-${{ matrix.rid }}${{ steps.meta.outputs.suffix }}.*
          retention-days: 7
          if-no-files-found: error
